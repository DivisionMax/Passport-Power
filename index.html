<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Varela' rel='stylesheet' type='text/css'>
    <!-- Load the d3 library. -->
    <script src="d3.min.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <style>
        .country:hover{
          stroke: #fff;
          stroke-width: 1.2px;
        }
        #explanation {
          font-family: Helvetica;
          margin: 10px 10%;
        }
        #container {
          margin:10px 10%;
          padding:20px;
          border:2px solid #d0d0d0;
          border-radius: 5px;
          height:100%;
        }
        .hidden {
          display: none;
        }
        div.tooltip {
          color: #222;
          background: #fff;
          padding: .5em;
          text-shadow: #f5f5f5 0 1px 0;
          border-radius: 2px;
          box-shadow: 0px 0px 2px 0px #a6a6a6;
          opacity: 0.9;
          position: absolute;
        }
    </style>
  </head>

  <body>
    <div id="explanation">
      <h3 style=" font-size: 36px; text-align: center;">Passport Power</h3>
      <p>How many countries can you travel to with your passport? <br>
        Our visualization explores the power of passports. The lines that shoot out from a country when clicked represent
        point out the countries you are able to travel to <b>visa-free</b>! <br>
        Upon clicking, you can see the country name and the region as well as the number of incoming tourists per year to this
        country. <br>
        The colors of each line correspond to the nubmer of outgoing tourists from the selected country each year.
        The darker the color, the more outgoing tourists.</p>

    </div>

    <div id="container"></div>

    <script>
        var lower_middle_income;
        var upper_middle_income;
        var high_income;
        var avg;


        d3.json("cleandata.json", function (error, data){
          //Part of the code taken from: http://techslides.com/responsive-d3-map-with-zoom-and-pan-limits
          d3.select(window).on("resize", throttle);

          var zoom = d3.behavior.zoom()
              .scaleExtent([1, 8])

          var throttleTimer;
          function throttle() {
            window.clearTimeout(throttleTimer);
              throttleTimer = window.setTimeout(function() {
                redraw();
              }, 200);
          }

          var width = document.getElementById('container').offsetWidth-60;
          var height = width / 2;

          var topo,projection,path,svg,g;

          var tooltip = d3.select("#container").append("div").attr("class", "tooltip hidden");

          setup(width,height);

          function setup(width,height){
            projection = d3.geo.mercator()
              .translate([0, 0])
              .scale(width / 2 / Math.PI);

            path = d3.geo.path()
                .projection(projection);

            svg = d3.select("#container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
                .call(zoom);

            g = svg.append("g");
          }

          numbers = data;

          maxGDP = d3.max(numbers, function(d) {return d.gdp_percapita});
          minGDP = d3.min(numbers, function(d) {return d.gdp_percapita});
          sumGDP = d3.sum(numbers, function(d) {return d.gdp_percapita} ) - maxGDP - minGDP;
          avg =  sumGDP / (numbers.length - 2);

          lower_middle_income = avg * 3/4
          upper_middle_income = avg
          high_income = avg * 1.25

          var countryColor = function(income){
            if (income == "high"){
                return "#1F77B4"; //high income
              }
              else if (income == "upper") {
                return "#2CA02C"; //upper middle income
              }
              else if (income == "lower") {
                return "#FFBB78"; //lower middle income
              }
              else if (income == "low") {
                return "#FF7F0E"; //low income
              }
              else{
                return "#CCC"; //unknown GDP
              }
          };

          function getIncomeGroup(code) {
            for (var i = 0; i < numbers.length; i++) {
               if (numbers[i].iso3_digit_code == code){
                 if (numbers[i].gdp_percapita >= high_income) {
                   return "high";
                 }
                 else if (numbers[i].gdp_percapita >= upper_middle_income && numbers[i].gdp_percapita < high_income) {
                   return "upper";
                 }
                 else if (numbers[i].gdp_percapita >= lower_middle_income && numbers[i].gdp_percapita < upper_middle_income) {
                   return "lower";
                 }
                 else if (numbers[i].gdp_percapita < lower_middle_income) {
                   return "low";
                 }
                 else{
                   return "No Available Data";
                 }
               }
           }
           return "No Available Data";
          }

          function getIncome(code) {
            for (var i = 0; i < numbers.length; i++){
              if (numbers[i].iso3_digit_code == code){
                return numbers[i].gdp_percapita;
              }
            }
            return "No Available Data";
          }

          function getCoordinates(code) {
            for (var i = 0; i < numbers.length; i++){
              if (numbers[i].iso3_digit_code == code){
                return projection([numbers[i].long, numbers[i].lat]);
              }
            }
            return projection([0, 0]);
          }

          function getCountryname(code) {
            for (var i = 0; i < numbers.length; i++){
              if (numbers[i].iso3_digit_code == code){
                return numbers[i].country_name;
              }

            }
            return "Unknown";
          }

          function getIncomingTourists(code) {
            for (var i = 0; i < numbers.length; i++){
              if (numbers[i].iso3_digit_code == code){
                return numbers[i].incoming;
              }

            }
            return "No Available Data";
          }

          var worldData;
          d3.json("world-topo.json", function(error, world) {
            worldData = world;
              // Use topojson to create an array containing one object per country.
              var countries = topojson.feature(world, world.objects.countries).features;
              topo = countries;
              draw(topo);
          });

          function calculateMinDistance(coords, countryCoords){
            return (Math.sqrt(Math.pow((coords[0] - countryCoords[0]), 2)
            + Math.pow((coords[1] - countryCoords[1]), 2)))
          }

          var drawConnections = function (coords){
                d3.json("cleandata.json", function (error1, data1){

                  var country = data1[0];
                  data1.forEach(function(d){
                    if (calculateMinDistance(coords, projection([d.long, d.lat])) <
                    calculateMinDistance(coords, projection([country.long, country.lat]))) {
                      country = d;
                    }

                  });
                  var countryCoords = projection([country.long, country.lat]);

                  var initialCircle = svg.append("circle").attr("r",5).attr("cx",countryCoords[0])
                  .attr("cy",countryCoords[1]).attr("fill","red");

                  svg.append("text").attr("x",countryCoords[0])
                  .attr("y",countryCoords[1] + 20).attr("fill","black").text(country.country_name)
                  .attr("text-anchor","middle");

                  // svg.append("circle").attr("r",5).attr("cx",chinaCoords[0])
                  // .attr("cy",chinaCoords[1]).attr("fill","red");
                  //
                  // svg.append("text").attr("x",chinaCoords[0])
                  // .attr("y",chinaCoords[1] + 20).attr("fill","black").text("China")
                  // .attr("text-anchor","middle");

                  // var lineData = [ { "x": indiaCoords[0],   "y": indiaCoords[1]}];
                  //                  //{ "x": chinaCoords[0],  "y": chinaCoords[1]}];
                  // //This is the accessor function we talked about above
                  // var lineFunction = d3.svg.line()
                  //                   .x(function(d) { return d.x; })
                  //                   .y(function(d) { return d.y; })
                  //                   .interpolate("linear");
                  //
                  //
                  // //The line SVG Path we draw
                  // var lineGraph = svg.append("path")
                  //                     .attr("d", lineFunction(lineData))
                  //                     .attr("stroke", "blue")
                  //                     .attr("stroke-width", 2)
                  //                     .attr("fill", "none");
                  //

                  //lineGraph.transition().duration(1000);//.attr("x2", function (point) {
                  //   return xScale(centroids[point.cluster].x);
                  //})
                  // .attr("y2", function (point) {
                  //    return yScale(centroids[point.cluster].y);
                  // });

                  var connectionCoords = (country.connections).map(function(d){
                    var targetCountry;
                    data1.forEach(function(d2){
                      if (d2.country_name == d){
                        targetCountry = d2;
                      }
                    });
                    return targetCountry;

                  });

                  var lines = svg.selectAll("line").data(connectionCoords);
                  lines.enter().append("line")
                  .attr("x1", projection([country.long, country.lat])[0])
                  .attr("y1", projection([country.long, country.lat])[1])
                  .attr("x2", projection([country.long, country.lat])[0])
                  .attr("y2", projection([country.long, country.lat])[1])
                  .style("stroke", "blue")
                  .attr("stroke-width", 1);

                   lines.transition().duration(1000)
                   .attr("x2", function(d) { return (projection([d.long, d.lat]))[0]; })
                   .attr("y2", function(d) { return (projection([d.long, d.lat]))[1]; });

                   connectionCoords.forEach(function(d){
                     svg.append("circle").attr("r",5).attr("cx",projection([d.long, d.lat])[0])
                     .attr("cy",projection([d.long, d.lat])[1]).attr("fill","red");

                     svg.append("text").attr("x",projection([d.long, d.lat])[0])
                     .attr("y",projection([d.long, d.lat])[1] + 20).attr("fill","black").text(d.country_name)
                     .attr("text-anchor","middle");

                   });



                 });
          }

          function draw(topo) {
            var country = g.selectAll(".country").data(topo);

            country.enter().insert("path")
                .attr("class", "country")
                .attr("d", path)
                .style("fill", function (d) {return countryColor(getIncomeGroup(d.id))} )

                //ofsets plus width/height of transform, plsu 20 px of padding, plus 20 extra for tooltip offset off mouse
                var offsetL = document.getElementById('container').offsetLeft+(width/2)+40;
                var offsetT =document.getElementById('container').offsetTop+(height/2)+20;

                //tooltips
                country
                  .on("mouseover", function(d,i) {
                    var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
                      tooltip
                        .classed("hidden", false)
                        .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
                        .html(getCountryname(d.id) +
                              " <br> GDP per Capita: " + getIncome(d.id) +
                              " <br> Incoming Tourists/Year: " + getIncomingTourists(d.id))
                    })
                    .on("mouseout",  function(d,i) {
                      tooltip.classed("hidden", true)
                    });
                country
                    .on("click", function(d,i) {
                      var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
                      drawConnections(mouse);
                    });
            }

           function redraw() {
            width = document.getElementById('container').offsetWidth-60;
            height = width / 2;
            d3.select('svg').remove();
            setup(width,height);
            draw(topo);
          }
        });

//fix mouseover display
//only color countries when a connection hits them
//have thicker demarcations between countries so we can click on them
//maybe have countries grow larger as you mouseover
//figure out a way of making it look nice when you have all the connections of a very connected country
//have some sort of dropdown and/or statistics with graphs below
//work on hiding connections of one country when you click on another
//also closest function needs work
//also have some way of making the initial click country superior somehow
//also do we have the correct Data for some countries like USA
    </script>
  </body>
</html>
