<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Varela' rel='stylesheet' type='text/css'>
    <!-- Load the d3 library. -->
    <script src="d3.min.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <style>
        body { 
            font-family: 'Varela', sans-serif; 
            } 
        div { 
            margin: 30px; 
        }
        svg { }

        .axis path { fill: none; stroke: #777; }
        .axis line { stroke: #777; }
    </style>
  </head>

  <body>
    <h2>Passport Power</h2>
    <div id="countryid"></div>
    <!-- SVG element-->
    <div id="canvas"></div>
    
    <script>
        var lower_middle_income;
        var upper_middle_income;
        var high_income;
        var avg;
        
        d3.json("test.json", function (error, data){
          numbers = data;
          
          avg = d3.sum(numbers, function(d) {return d.gdp_percapita} ) / numbers.length;
          
          lower_middle_income = avg
          upper_middle_income = avg * 1.25
          high_income = avg * 1.5
          
          var width = 1400,
              height = 600;
          var svg = d3.select("#canvas").append("svg")
                    .attr("height", height)
                    .attr("width", width);
  
          var g = svg.append("g");

          var projection = d3.geo.equirectangular();
          var path = d3.geo.path().projection(projection);
          
          var countryColor = function(income){
            if (income == "high"){
                return "#458B00"; //high income
              }
              else if (income == "upper") {
                return "#9CBA7F"; //upper middle income
              }
              else if (income == "lower") {
                return "#FF8E7A"; //lower middle income
              }
              else if (income == "low") {
                return "#CC4F39"; //low income
              }
              else{
                return "#FFF"; //unknown GDP
              }
          };
          
          function getIncomeGroup(code) {
            for (var i = 0; i < numbers.length; i++) {
               if (numbers[i].iso3_digit_code == code){
                 if (numbers[i].gdp_percapita >= high_income) {
                   return "high";
                 }
                 else if (numbers[i].gdp_percapita >= upper_middle_income && numbers[i].gdp_percapita < high_income) {
                   return "upper";
                 }
                 else if (numbers[i].gdp_percapita >= lower_middle_income && numbers[i].gdp_percapita < upper_middle_income) {
                   return "lower";
                 }
                 else if (numbers[i].gdp_percapita < lower_middle_income) {
                   return "low";
                 }
                 else{
                   return "unknown";
                 }
               }
           }   
           return "";          
          }
          
          function getCoordinates(code) {
            for (var i = 0; i < numbers.length; i++){
              if (numbers[i].iso3_digit_code == code){
                return projection([numbers[i].long, numbers[i].lat]);
              }
            }
            return projection([0, 0]);
          }
          
          function getCountryname(code) {
            for (var i = 0; i < numbers.length; i++){
              if (numbers[i].iso3_digit_code == code){
                return numbers[i].country_name;
              }
            
            }
            return "error";
          }
              
          var worldData;
          
          d3.json("world-50m.json", function(error, world) {
            worldData = world;
              // Use topojson to create an array containing one object per country.
              var countries = topojson.feature(world, world.objects.countries).features;
              
              g.selectAll("path")
                .data(countries)
                .enter().append("path")
                .attr("d", path)
                .style("fill", function (d) {return countryColor(getIncomeGroup(d.id))} )
                .style("stroke", "#888")
                .on("click", function (d) {
                    //click to show country name
                    svg.append("text")
                    .attr("x", getCoordinates(d.id)[0])
                    .attr("y", getCoordinates(d.id)[1])
                    .text(getCountryname(d.id))
                    .attr("fill", "black");
                    //next click removes first click
                    
                    //click to enlarge country
                    
                });
          });
        });
    </script>
  </body>
</html>